---
import DeleteModal from "@/components/modals/restaurant/deleteModal.astro";
import UpdateRestaurantModal from "@/components/modals/restaurant/updateRestaurantModal.astro";
import DeleteReviewModal from "@/components/modals/review/deleteReviewModal.astro";
import { getReviewsByRestaurant } from "@/repository/restaurants";

const {restaurant, restaurantId} = Astro.props;

const reviews = await getReviewsByRestaurant(restaurantId);
---
<div class="bg-white rounded-lg border border-gray-20 py-8 px-4 mx-auto max-w-screen-xl sm:py-16 lg:px-6">
    <div class="py-6 px-4 mx-auto max-w-screen-xl sm:py-6 lg:px-6">
       <div class="max-w-screen-md mb-8 lg:mb-16">
           <h2 class="mb-4 text-4xl tracking-tight font-extrabold text-gray-900 ">Restaurante</h2>          
       </div>
      
   </div>
   <div class="rounded-lg border border-gray-200 bg-gray-50 pb-6 pt-0 md:p-10 m-6">
     <div class="relative flex space-x-4">
      <img 
                src={restaurant.photo} 
                alt="Foto de perfil" 
                class="w-full h-48 mb-2 object-cover rounded-md" 
              />
     </div>
   </div>

   <!--OTRA FORMA PARA LA IMAGEN:
    <div class="rounded-lg border border-gray-200 bg-gray-50 pb-6 pt-0 md:p-10 m-6 flex justify-center">
    <div class="max-w-xs w-full">
      <img 
        src={restaurant.photo} 
        alt="Foto del restaurante" 
        class="w-full h-48 object-cover rounded-md shadow-md"
      />
    </div>
  </div>
   -->
   <div class="relative rounded-lg border border-gray-200 bg-gray-50  pt-14 md:p-10 m-6">
     <h2 class="mb-4 text-xl font-semibold text-gray-900 sm:text-2xl md:mb-6">Datos personales</h2>
     <div class="absolute top-0 right-0 mt-4 mr-4 flex flex-col gap-2">
        <button type="button" id="updateRestButton" data-modal-target="updateRestModal" data-modal-toggle="updateRestModal"
          class="text-blue-700 hover:text-white border border-blue-100 bg-blue-100 hover:bg-blue-600 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
          Editar
        </button>
        <button type="button" id="deleteRestButton" data-modal-target="deleteRestModal" data-modal-toggle="deleteRestModal"
          class="text-red-700 hover:text-white border border-red-100 bg-red-100 hover:bg-red-600 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
          Eliminar
        </button>
      </div>
     <!--DATOS PERSONALES Usuarios -->
     <div class="py-3 md:py-3">
      <div class="mb-4 grid gap-4 sm:grid-cols-3 sm:gap-8 lg:gap-16">
        <div class="space-y-4">
          <dl class="">
            <dt class="font-semibold text-gray-900">Name</dt>
            <dd class="text-gray-500">{restaurant.name}</dd>
          </dl>
          <dl>
            <dt class="font-semibold text-gray-900">Address</dt>
            <dd class="flex items-center gap-1 text-gray-500">
              <svg
                class="hidden h-5 w-5 shrink-0 text-gray-400 lg:inline"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="none"
                viewBox="0 0 24 24"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="m4 12 8-8 8 8M6 10.5V19a1 1 0 0 0 1 1h3v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h3a1 1 0 0 0 1-1v-8.5"
                />
              </svg>
              {restaurant.address}
            </dd>
          </dl>
        </div>
        <div class="space-y-4">
          <dl>
            <dt class="font-semibold text-gray-900">URL Web</dt>
            <dd class="text-gray-500 max-w-full overflow-hidden text-ellipsis whitespace-nowrap">
              <a
                href={restaurant.website}
                class="underline text-gray-500 hover:text-blue-800 truncate"
                target="_blank"
                rel="noopener noreferrer"
              >
                {restaurant.website}
              </a>
            </dd>
          </dl>
          <dl>
            <dt class="font-semibold text-gray-900">URL Maps</dt>
            <dd class="flex items-center gap-1 text-gray-500 max-w-full overflow-hidden text-ellipsis whitespace-nowrap">
              <a
                href={restaurant.maps_url}
                class="underline text-gray-500 hover:text-blue-800 truncate"
                target="_blank"
                rel="noopener noreferrer"
              >
                {restaurant.maps_url}
              </a>
            </dd>
          </dl>
        </div>
        <div class="space-y-4">
          <dl>
            <dt class="font-semibold text-gray-900">Url Photo</dt>
            <dd class="text-gray-500 max-w-full overflow-hidden text-ellipsis whitespace-nowrap">
              <a
                href={restaurant.photo}
                class="underline text-gray-500 hover:text-blue-800 truncate"
                target="_blank"
                rel="noopener noreferrer"
              >
                {restaurant.photo}
              </a>
            </dd>
          </dl>
        </div>
      </div>
    </div>
    
     <!--FIN DATOS PERSONALES Usuarios -->
   </div>
   <!--RESEÑAS -->
   <div class="relative rounded-lg border border-gray-200 bg-gray-50  pt-14 md:p-10 m-6">
     <h2 class="mb-4 text-xl font-semibold text-gray-900 sm:text-2xl md:mb-6">Reviews</h2>
   
   <!-- RESEÑAS DEL RESTAURANTE -->
      {reviews.map((review) => (
        <div class="py-6 border-t border-gray-200 first:border-0">
          <div class="grid gap-4 sm:grid-cols-1 lg:grid-cols-6">
            
            <!-- Foto del usuario -->
            <div class="lg:col-span-1">
              {review.userPhoto && (
                <img
                  src={review.userPhoto}
                  alt={`${review.userName} ${review.userSurname}`}
                  class="w-16 h-16 rounded-md object-cover"
                />
              )}
            </div>

            <!-- Contenido principal -->
            <div class="lg:col-span-5 space-y-2 relative">
              <button type="button" class="absolute top-0 right-0 mt-1 text-red-700 hover:text-white border border-red-100 bg-red-100 hover:bg-red-200 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-3 py-1.5 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="#e11d48" d="M7 21q-.825 0-1.412-.587T5 19V6H4V4h5V3h6v1h5v2h-1v13q0 .825-.587 1.413T17 21zm2-4h2V8H9zm4 0h2V8h-2z"/></svg>
              </button>
              <DeleteReviewModal review={review} modalId={`deleteReviewModal-${review.id}`} user={{ id: review.userId }}/>
              <!-- Usuario y fecha -->
              <dl>
                <dt class="font-semibold text-gray-900">
                  {review.userName} {review.userSurname}
                </dt>
                <dd class="text-sm text-gray-500">
                  {review.createdAt
                    ? new Date(review.createdAt).toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric',
                      })
                    : 'Fecha desconocida'}
                </dd>
              </dl>

              <!-- Reseña -->
              <p class="text-gray-700">
                {review.description}
              </p>

              <!-- Condición digestiva -->
              <div class="flex items-center space-x-2">
                <span class={`inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium 
                  ${review.suitable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                  {review.suitable ? `Apto para ${review.digestiveCondition}` : 'No apto'}
                </span>
              </div>
            </div>
          </div>
        </div>
      ))}
     <!--FIN reseña1-->
   
   </div>
   <DeleteModal restaurant={restaurant} />
   <UpdateRestaurantModal restaurant={restaurant} />
</div>




