---
import { getUserFromSession } from "@/repository/users";
import LayoutUser from "@/layouts/LayoutUser.astro";
import ReviewsList from "@/components/user/reviews/reviewsList.astro";
import { getReviewsByUser, insertEditReview } from "@/repository/reviews";
import { updateReview } from "@/services/update/updateReview";



if (Astro.locals.user === null) {
  return Astro.redirect('/login'); // Redirigir a login si no hay usuario autenticado
}

const cookies = Astro.cookies;
const sessionId = cookies.get("session")?.value;

let user = null;
if (sessionId) {
  user = await getUserFromSession(sessionId);
}
if (!user) {
  return Astro.redirect('/login');
}
const reviews = await getReviewsByUser(user.id);

if (Astro.request.method === "POST") {
  try {
    let data = await Astro.request.formData();
    const formId = data.get("formId");
    if (formId === "update_review") {
      const updatedReview= await updateReview(data);
      await insertEditReview(updatedReview);
      return Astro.redirect(`/user/reviews/${user.id}`);
    
    }else {
      console.error("Form ID no reconocido:", formId); // Depuraci√≥n
    }
    
  }catch (error) {
      console.error("Error procesando el form", error);
  }
}
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get("q") || "";
---
<LayoutUser user={user}>
    <ReviewsList user={user} reviews={reviews} searchQuery={searchQuery} />
</LayoutUser>
